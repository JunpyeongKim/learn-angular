<!DOCTYPE html>
<html lang="en" ng-app="exampleApp">
<head>
    <meta charset="UTF-8">
    <title>Ajax</title>
    <script src="angular.js"></script>
    <link href="bootstrap.css" rel="stylesheet"/>
    <link href="bootstrap-theme.css" rel="stylesheet"/>
    <script>
        angular.module('exampleApp', []).
                config(function ($httpProvider) {
                    $httpProvider.defaults.transformResponse.push(function (data, headers) {
                        if (headers('content-type') === 'application/xml' && angular.isString(data)) {
                            var products = [];
                            var productElems = angular.element(data.trim()).find('product');

                            for (var i = 0; i < productElems.length; i++) {
                                var product = productElems.eq(i);
                                products.push({
                                    name: product.attr('name'),
                                    category: product.attr('category'),
                                    price: product.attr('price'),
                                    expiry: product.attr('expiry')
                                });
                            }

                            return products;
                        } else {
                            return data;
                        }
                    });

                    // Request Interceptors
                    $httpProvider.interceptors.push(function () {
                        return {
                            request: function (config) {
                                config.url = 'productdata.json';
                                return config;
                            },

//                            requestError: function (config) {},

                            response: function (response) {
                                console.log('Data count: ' + response.data.length);
                                return response;
                            }

//                            , responseError: function (response) {}
                        };
                    });
                }).
                controller('defaultCtrl', function ($scope, $http) {
                    $scope.loadData = function () {

                        //---
//                        $http.get('productData.json').
//                                success(function (data, status, headers, config) {
//                                    console.log('Status: ' + status);
//                                    console.log('Type: ' + headers('content-type'));
//                                    console.log('Length: ' + headers('content-length'));
//
//                                    $scope.products = data;
//                                });

                        //---
//                        $http.get('productData.json').then(function (response) {
//                            console.log('Status: ' + response.status);
//                            console.log('Type: ' + response.headers('content-type'));
//                            console.log('Length: ' + response.headers('content-length'));
//                            $scope.products = response.data;
//                        });

                        //---
//                        $http.get('productData.xml').then(function (response) {
//                            $scope.products = [];
//
//                            // jqLite 사용
//                            var productElems = angular.element(response.data.trim()).find('product');
//                            for (var i = 0; i < productElems.length; i++) {
//                                var product = productElems.eq(i);
//                                $scope.products.push({
//                                    name: product.attr('name'),
//                                    category: product.attr('category'),
//                                    price: product.attr('price'),
//                                    expiry: product.attr('expiry')
//                                });
//                            }
//                        });

                        //---
//                        var config = {
//                            transformResponse: function (data, headers) {
//                                if (headers('content-type') === 'application/xml' && angular.isString(data)) {
//                                    var products = [];
//                                    var productElems = angular.element(data.trim()).find('product');
//
//                                    for (var i = 0; i < productElems.length; i++) {
//                                        var product = productElems.eq(i);
//                                        products.push({
//                                            name: product.attr('name'),
//                                            category: product.attr('category'),
//                                            price: product.attr('price'),
//                                            expiry: product.attr('expiry')
//                                        });
//                                    }
//
//                                    return products;
//                                } else {
//                                    return data;
//                                }
//                            }
//                        };
//
//                        $http.get('productData.xml', config).success(function (data) {
//                            $scope.products = data;
//                        });

                        //---
                        $http.get('productData.xml').success(function (data) {
                            $scope.products = data;
                        });

                    };

                    $scope.sendData = function () {
                        var config = {
                            headers: {
                                'content-type': 'application/xml'   // 반드시 명시적으로 설정
                            },
                            transformRequest: function (data, headers) {
                                var rootElem = angular.element('<xml>');    // dummy element --> 최종 결과에는 포함되지 않음

                                for (var i = 0; i < data.length; i ++) {
                                    var prodElem = angular.element('<product>');
                                    prodElem.attr('name', data[i].name);
                                    prodElem.attr('category', data[i].category);
                                    prodElem.attr('price', data[i].price);
//                                    prodElem.attr('expiry', data[i].expiry);

                                    rootElem.append(prodElem);
                                }

                                rootElem.children().wrap('<products>'); // 원하는 최상위 엘리먼트 삽입
                                return rootElem.html();
                            }
                        };

                        $http.post('ajax.html', $scope.products, config);
                    };
                });
    </script>
</head>
<body ng-controller="defaultCtrl">
    <div class="panel panel-default">
        <div class="panel-body">
            <table class="table table-striped table-bordered">
                <thead><tr><th>Name</th><th>Category</th><th>Price</th></tr></thead>
                <tbody>
                    <tr ng-hide="products.length">
                        <td colspan="3" class="text-center">No Data</td>
                    </tr>
                    <tr ng-repeat="item in products">
                        <td>{{item.name}}</td>
                        <td>{{item.category}}</td>
                        <td>{{item.price | currency}}</td>
                    </tr>
                </tbody>
            </table>
            <p>
                <button class="btn btn-primary"
                        ng-click="loadData()">
                    Load Data
                </button>
                <button class="btn btn-primary"
                        ng-click="sendData()">
                    Send Data
                </button>
            </p>
        </div>
    </div>
</body>
</html>